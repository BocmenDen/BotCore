name: Publish NuGet (on version change)

on:
  push:
    paths:
      - 'Directory.Build.props'

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 2

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.x'
  
    - name: Install xmllint
      run: sudo apt-get update && sudo apt-get install -y libxml2-utils

    - name: Check if <Version> changed
      id: check_version
      run: |
        git show HEAD^:Directory.Build.props > old.props || echo "<Version>none</Version>" > old.props
        NEW=$(xmllint --xpath "string(//Version)" Directory.Build.props)
        OLD=$(xmllint --xpath "string(//Version)" old.props || echo "none")
        echo "OLD=$OLD"
        echo "NEW=$NEW"
        if [ "$NEW" != "$OLD" ]; then
          echo "version_changed=true" >> $GITHUB_OUTPUT
        else
          echo "version_changed=false" >> $GITHUB_OUTPUT
        fi

    - name: Restore dependencies
      run: dotnet restore

    - name: Build
      run: dotnet build -c Release --no-restore

    - name: Pack
      if: steps.check_version.outputs.version_changed == 'true'
      run: dotnet pack -c Release --no-build -o ./nupkgs

    - name: Push NuGet package
      if: steps.check_version.outputs.version_changed == 'true'
      run: |
        dotnet nuget push "./nupkgs/*.nupkg" --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json
        dotnet nuget push "./nupkgs/*.snupkg" --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json
